FROM --platform=linux/amd64 flink:2.0.1-scala_2.12-java21
# https://hub.docker.com/_/flink
# flink connectors not available for 2.2 --> using 2.0

# flink 2.0 supports python 3.11
# flink 2.2 supports python 3.9, 3.10, 3.11, 3.12

ENV FLINK_VERSION=2.0.1
ENV KAFKA_VERSION=3.9.0

RUN apt-get update -y && \
    apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev libffi-dev liblzma-dev && \
    wget https://www.python.org/ftp/python/3.11.14/Python-3.11.14.tgz && \
    tar -xvf Python-3.11.14.tgz && \
    cd Python-3.11.14 && \
    ./configure --without-tests --enable-shared && \
    make -j6 && \
    make install && \
    ldconfig /usr/local/lib && \
    cd .. && rm -f Python-3.11.14.tgz && rm -rf Python-3.11.14 && \
    ln -s /usr/local/bin/python3 /usr/local/bin/python && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# install pyFlink
COPY requirements.txt .
RUN python -m pip install --upgrade pip; \
    pip3 install --upgrade google-api-python-client; \
    pip3 install -r requirements.txt  --no-cache-dir;

# download Flink connectors
# Kafka Clients: https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients
# Flink JSON: https://mvnrepository.com/artifact/org.apache.flink/flink-json
# Flink SQL Kafka: https://mvnrepository.com/artifact/org.apache.flink/flink-sql-connector-kafka
# PostgreSQL JDBC Driver: https://mvnrepository.com/artifact/org.postgresql/postgresql
RUN \
    wget -P /opt/flink/lib/ "https://repo.maven.apache.org/maven2/org/apache/flink/flink-json/${FLINK_VERSION}/flink-json-${FLINK_VERSION}.jar"; \
    wget -P /opt/flink/lib/ "https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-connector-kafka/${FLINK_VERSION}/flink-sql-connector-kafka-${FLINK_VERSION}.jar"; \
    wget -P /opt/flink/lib/ "https://repo.maven.apache.org/maven2/org/apache/flink/flink-connector-jdbc/${FLINK_VERSION}/flink-connector-jdbc-${FLINK_VERSION}.jar"; \
    wget -P /opt/flink/lib/ "https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.10/postgresql-42.7.10.jar";

RUN echo "taskmanager.memory.jvm-metaspace.size: 512m" >> /opt/flink/conf/flink-conf.yaml;

WORKDIR /opt/flink

# https://mvnrepository.com/artifact/org.apache.flink/flink-sql-connector-kafka/4.0.1-2.0

# ALT GENERATED BY CLAUDE:

# # Dockerfile for Flink with Kafka connector pre-installed
# #
# # This builds a custom Flink image with the Kafka connector JARs
# # already included, so you don't need to download them separately.

# FROM flink:1.18-scala_2.12

# # Install curl for downloading JARs
# USER root
# RUN apt-get update && \
#     apt-get install -y curl && \
#     rm -rf /var/lib/apt/lists/*

# # Versions
# ENV FLINK_VERSION=1.18.0
# ENV KAFKA_VERSION=3.2.3

# # Download Flink Kafka connector
# RUN curl -L -o /opt/flink/lib/flink-sql-connector-kafka-${FLINK_VERSION}.jar \
#     https://repo1.maven.org/maven2/org/apache/flink/flink-sql-connector-kafka/${FLINK_VERSION}/flink-sql-connector-kafka-${FLINK_VERSION}.jar

# # Download Kafka clients library
# RUN curl -L -o /opt/flink/lib/kafka-clients-${KAFKA_VERSION}.jar \
#     https://repo1.maven.org/maven2/org/apache/kafka/kafka-clients/${KAFKA_VERSION}/kafka-clients-${KAFKA_VERSION}.jar

# # Verify JARs were downloaded
# RUN ls -lh /opt/flink/lib/*.jar

# # Install Python and PyFlink for Python job support
# RUN apt-get update && \
#     apt-get install -y python3 python3-pip python3-dev && \
#     rm -rf /var/lib/apt/lists/*

# # Install PyFlink
# RUN pip3 install --no-cache-dir apache-flink==${FLINK_VERSION}

# # Switch back to flink user
# USER flink

# # Expose ports
# # 8081 - JobManager Web UI
# # 6123 - JobManager RPC
# # 6124-6130 - TaskManager ports
# EXPOSE 8081 6123 6124-6130

# # Default command (overridden by docker-compose)
# CMD ["help"]